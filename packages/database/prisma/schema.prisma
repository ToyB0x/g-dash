// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PACKAGES_DATABASE_DB_URL")
}

model Organization {
  id           String       @id // derived from the GitHub API
  login        String       @unique // The organization's login name (ensure uniqueness by github)
  Repositories Repository[]
  Prs          Pr[]
  Commits      Commit[]
  Reviews      Review[]
  Releases     Release[]
}

model User {
  id        String   @id
  login     String // not unique, because sync delays can cause duplicates login ids
  name      String?
  avatarUrl String
  Prs       Pr[]
  Commits   Commit[]
  Reviews   Review[]
}

model Repository {
  id                            String    @id // derived from the GitHub API
  name                          String
  hasVulnerabilityAlertsEnabled Boolean
  vulnerabilityAlertsTotalCount Int
  pushedAt                      DateTime? // if no push has happened, this will be null
  organizationId                String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Release {
  id             String   @id // derived from the GitHub API
  tagName        String
  url            String
  publishedAt    DateTime
  organizationId String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Pr {
  id             String @id
  organizationId String
  authorId       String
  title          String
  url            String

  additions    Int
  deletions    Int
  changedFiles Int

  commentsTotalCount Int
  commitsTotalCount  Int

  merged Boolean
  closed Boolean

  createdAt DateTime
  closedAt  DateTime?
  mergedAt  DateTime?

  user         User         @relation(fields: [authorId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
}

model Commit {
  id             String   @id
  organizationId String
  url            String
  committedDate  DateTime
  authorId       String

  user         User         @relation(fields: [authorId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, committedDate])
}

model Review {
  id             String   @id
  organizationId String
  url            String
  authorId       String
  createdAt      DateTime

  user         User         @relation(fields: [authorId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, authorId])
}
